name: Build and Release Android App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build and Release APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Make gradlew executable
      run: chmod +x ./gradlew
    
    - name: Generate debug keystore
      run: |
        mkdir -p $HOME/.android
        echo "storePassword=android" > keystore.properties
        echo "keyPassword=android" >> keystore.properties
        echo "keyAlias=androiddebugkey" >> keystore.properties
        echo "storeFile=$HOME/.android/debug.keystore" >> keystore.properties
        keytool -genkey -v -keystore $HOME/.android/debug.keystore \
          -storepass android -alias androiddebugkey -keypass android \
          -keyalg RSA -keysize 2048 -validity 10000 \
          -dname "CN=Android Debug,O=Android,C=US"
    
    - name: Build debug APK
      run: ./gradlew assembleDebug
      env:
        SIGNING_KEY_ALIAS: androiddebugkey
        SIGNING_KEY_PASSWORD: android
        SIGNING_STORE_PASSWORD: android
    
    - name: Get version from tag
      id: version
      run: |
        if [ "${{ github.ref_type }}" == "tag" ]; then
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          VERSION="$(date +%Y%m%d-%H%M%S)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=debug-$VERSION" >> $GITHUB_OUTPUT
        fi
    
    - name: Sign and rename APKs
      id: apk_info
      run: |
        mkdir -p signed_apks
        for APK_PATH in app/build/outputs/apk/debug/*.apk; do
          if [ -f "$APK_PATH" ]; then
            BASENAME=$(basename "$APK_PATH" .apk)
            if [[ "$BASENAME" =~ (arm64-v8a|armeabi-v7a|x86_64|x86) ]]; then
              ARCH="${BASH_REMATCH[1]}"
              OUTPUT_NAME="truehub-${{ steps.version.outputs.version }}-${ARCH}.apk"
            else
              OUTPUT_NAME="truehub-${{ steps.version.outputs.version }}.apk"
            fi
            $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
              --ks $HOME/.android/debug.keystore \
              --ks-key-alias androiddebugkey \
              --ks-pass pass:android \
              --key-pass pass:android \
              --out "signed_apks/$OUTPUT_NAME" \
              "$APK_PATH"
            $ANDROID_HOME/build-tools/34.0.0/apksigner verify "signed_apks/$OUTPUT_NAME"
            echo "âœ“ Created: $OUTPUT_NAME"
          fi
        done
        TOTAL_SIZE=$(du -sb signed_apks | cut -f1)
        TOTAL_SIZE_MB=$(echo "scale=2; $TOTAL_SIZE / 1024 / 1024" | bc)
        echo "total_size=${TOTAL_SIZE_MB}MB" >> $GITHUB_OUTPUT
        ls -lh signed_apks/
    
    - name: Generate changelog
      id: changelog
      run: |
        PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | head -2 | tail -1)
        if [ -z "$PREVIOUS_TAG" ]; then
          PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
        fi
        
        echo "## Changelog" > changelog.md
        echo "" >> changelog.md
        git log ${PREVIOUS_TAG}..${{ steps.version.outputs.tag_name }} --pretty=format:"- %s (%h)" >> changelog.md
    
    - name: Create Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cat > release_body.md << 'EOF'
        ## TrueHub ${{ steps.version.outputs.version }}
        
        ### Download
        
        **Universal:** `truehub-${{ steps.version.outputs.version }}.apk`
        
        **Architecture-specific:**
        - `truehub-${{ steps.version.outputs.version }}-arm64-v8a.apk`
        - `truehub-${{ steps.version.outputs.version }}-armeabi-v7a.apk`
        - `truehub-${{ steps.version.outputs.version }}-x86_64.apk`
        
        **Total size:** ${{ steps.apk_info.outputs.total_size }}
        
        EOF
        
        cat changelog.md >> release_body.md
        
        gh release create "${{ steps.version.outputs.tag_name }}" \
          signed_apks/*.apk \
          --title "${{ steps.version.outputs.tag_name }}" \
          --notes-file release_body.md
    
    - name: Upload APKs as Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: truehub-apks-${{ steps.version.outputs.version }}
        path: signed_apks/*.apk
        retention-days: 90
        compression-level: 0
